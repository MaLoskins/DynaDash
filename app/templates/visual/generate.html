{% extends "shared/base.html" %}

{% block title %}Generate Dashboard - DynaDash{% endblock %}

{% block content %}
<div class="py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Generate Dashboard</h1>
            {# Ensure data.view exists or provide a fallback #}
            <a href="{{ url_for('data.view', id=dataset.id) if 'data.view' in current_app.view_functions else url_for('visual.index') }}" class="text-blue-600 hover:text-blue-800">
                <i class="fas fa-arrow-left mr-1"></i> Back to Dataset
            </a>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Dataset Info -->
            <div class="md:col-span-1">
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800">Dataset Details</h2>
                    </div>
                    <div class="p-4">
                        <h3 class="font-medium text-gray-200 mb-1">{{ dataset.original_filename }}</h3>
                        <p class="text-sm text-gray-500 mb-4">
                            {{ dataset.file_type.upper() }} • {{ dataset.n_rows }} rows • {{ dataset.n_columns }} columns
                        </p>
                        <p class="text-sm text-gray-500">
                            <span class="font-medium">Uploaded:</span> {{ dataset.uploaded_at.strftime('%b %d, %Y') }}
                        </p>
                        <p class="text-sm text-gray-500">
                            <span class="font-medium">Visibility:</span> 
                            <span class="{{ 'text-green-600' if dataset.is_public else 'text-gray-800' }}">
                                {{ 'Public' if dataset.is_public else 'Private' }}
                            </span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Form -->
            <div class="md:col-span-2">
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800">Dashboard Options</h2>
                    </div>
                    <div class="p-4">
                        <form method="POST" action="{{ url_for('visual.generate', dataset_id=dataset.id) }}" id="dashboard-form">
                            {{ form.hidden_tag() }}
                            
                            <div class="mb-4">
                                <label for="title" class="block text-sm font-medium text-gray-700">
                                    {{ form.title.label }}
                                </label>
                                <div class="mt-1">
                                    {{ form.title(class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md") }}
                                    {% if form.title.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.title.errors %}
                                                <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="description" class="block text-sm font-medium text-gray-700">
                                    {{ form.description.label }}
                                </label>
                                <div class="mt-1">
                                    {{ form.description(class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md", rows=3, placeholder="Describe what insights you're looking for or what aspects of the data you want to highlight...") }}
                                    {% if form.description.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.description.errors %}
                                                <span>{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    Adding a descriptive explanation of your data and what insights you're looking for will help generate more relevant visualizations.
                                </p>
                            </div>
                            
                            <div class="mb-6">
                                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                    <span class="text-blue-800 text-sm">
                                        <strong>Note:</strong> Claude will analyze your dataset and automatically create a fully interactive dashboard with multiple visualizations. This process may take up to 60-90 seconds for larger datasets.
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex justify-end">
                                {{ form.submit(class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500", value="Generate Dashboard", id="submit-button") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Processing Modal -->
        <div id="processing-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-card-bg rounded-lg shadow-lg p-6 max-w-md w-full border border-border-color">
                <h3 class="text-xl font-bold text-text-color mb-4">Generating Dashboard</h3>
                <div class="mb-4">
                    <div class="progress-container">
                        <div id="progress-bar" style="width: 0%"></div>
                    </div>
                    <p id="progress-label" class="text-sm text-text-secondary mt-2">Initializing...</p>
                </div>
                <div class="text-text-secondary text-sm">
                    <p class="mb-2">Claude is analyzing your data and creating a custom dashboard. This may take 60-90 seconds to complete.</p>
                    <div id="steps-container" class="border border-border-color rounded p-2 mt-3">
                        <p class="text-xs text-text-tertiary mb-1">Current progress:</p>
                        <ul class="text-xs space-y-1">
                            <li id="step-1" class="flex items-center">
                                <span class="step-indicator" id="step-1-indicator"></span> 
                                <span>Preparing dataset and analyzing structure</span>
                            </li>
                            <li id="step-2" class="flex items-center text-text-tertiary">
                                <span class="step-indicator" id="step-2-indicator"></span> 
                                <span>Identifying key data relationships</span>
                            </li>
                            <li id="step-3" class="flex items-center text-text-tertiary">
                                <span class="step-indicator" id="step-3-indicator"></span> 
                                <span>Generating dashboard layout</span>
                            </li>
                            <li id="step-4" class="flex items-center text-text-tertiary">
                                <span class="step-indicator" id="step-4-indicator"></span> 
                                <span>Creating visualizations</span>
                            </li>
                            <li id="step-5" class="flex items-center text-text-tertiary">
                                <span class="step-indicator" id="step-5-indicator"></span> 
                                <span>Finalizing and saving dashboard</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div id="error-message-modal" class="mt-4 p-3 bg-red-100 border border-red-300 rounded text-red-700 text-sm hidden">
                    An error occurred. Please try again or contact support if the problem persists.
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
{# visual_generate.js is NOT for this page, it's for view.html #}
{# Add specific JS for this page if needed, e.g. for handling form submission with SocketIO progress #}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const dashboardForm = document.getElementById('dashboard-form');
    const processingModal = document.getElementById('processing-modal');
    const progressBar = document.getElementById('progress-bar');
    const progressLabel = document.getElementById('progress-label');
    const errorMessageModal = document.getElementById('error-message-modal');
    
    const steps = {
        1: { percent: 10, message: "Preparing dataset and analyzing structure", indicator: "step-1-indicator", text_el_id: "step-1" },
        2: { percent: 30, message: "Identifying key data relationships", indicator: "step-2-indicator", text_el_id: "step-2" },
        3: { percent: 50, message: "Generating dashboard layout", indicator: "step-3-indicator", text_el_id: "step-3" },
        4: { percent: 70, message: "Creating visualizations", indicator: "step-4-indicator", text_el_id: "step-4" },
        5: { percent: 90, message: "Finalizing and saving dashboard", indicator: "step-5-indicator", text_el_id: "step-5" }
    };

    function updateStepIndicator(currentPercent) {
        for (const stepNum in steps) {
            const step = steps[stepNum];
            const indicatorEl = document.getElementById(step.indicator);
            const textEl = document.getElementById(step.text_el_id);
            if (indicatorEl && textEl) {
                if (currentPercent >= step.percent) {
                    indicatorEl.classList.remove('bg-gray-300');
                    indicatorEl.classList.add('step-completed'); // Or 'step-active' if it's the current one
                    textEl.classList.remove('text-text-tertiary');
                    textEl.classList.add('text-text-color');
                } else {
                     indicatorEl.classList.remove('step-completed', 'step-active');
                     indicatorEl.classList.add('bg-gray-300');
                     textEl.classList.remove('text-text-color');
                     textEl.classList.add('text-text-tertiary');
                }
            }
        }
    }


    if (dashboardForm && processingModal && progressBar && progressLabel) {
        dashboardForm.addEventListener('submit', function(event) {
            // Client-side validation can be added here if needed before showing modal
            processingModal.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressLabel.textContent = 'Initializing...';
            if(errorMessageModal) errorMessageModal.classList.add('hidden'); // Clear previous errors
            updateStepIndicator(0); // Reset step indicators

            // SocketIO event listeners are now in common.js
            // This script just needs to trigger the submission
        });
    }

    // This part will be handled by common.js now
    // const socket = io(); // Assuming common.js initializes socket if user is authenticated
    // if (typeof socket !== 'undefined') { // Check if socket was initialized
    //     socket.on('progress_update', function(data) {
    //         if (progressBar && progressLabel) {
    //             progressBar.style.width = data.percent + '%';
    //             progressLabel.textContent = data.message;
    //             updateStepIndicator(data.percent);
    //         }
    //     });

    //     socket.on('processing_complete', function(data) {
    //         if (progressBar && progressLabel) {
    //             progressBar.style.width = '100%';
    //             progressLabel.textContent = 'Dashboard completed! Redirecting...';
    //             updateStepIndicator(100);
    //         }
    //         if (data && data.redirect_url) {
    //             window.location.href = data.redirect_url;
    //         } else {
    //             // Fallback if no redirect URL is provided
    //             setTimeout(() => { processingModal.classList.add('hidden'); }, 2000);
    //         }
    //     });

    //     socket.on('processing_error', function(data) {
    //         if (processingModal && errorMessageModal && progressLabel) {
    //             progressLabel.textContent = 'Error occurred.';
    //             errorMessageModal.textContent = 'Error: ' + data.message;
    //             errorMessageModal.classList.remove('hidden');
    //             // Optionally hide modal after a delay or provide a close button
    //             // setTimeout(() => { processingModal.classList.add('hidden'); }, 5000);
    //         } else {
    //             alert('Error: ' + data.message); // Fallback
    //         }
    //     });
    // }
});
</script>
{% endblock %}